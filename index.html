<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drag & Drop Scheduler</title>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    .logo {
      text-align: center;
      padding: 20px;
    }
    .logo img {
      max-width: 300px;
      height: auto;
    }
    .main-columns {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
      justify-content: center;
    }
    .column {
      flex: 1;
      min-width: 300px;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .column h2 {
      text-align: center;
    }
    .site-box, .holiday-sick-box, .unassigned {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .site-employees {
      min-height: 60px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      border: 1px dashed #ccc;
      padding: 5px;
      border-radius: 4px;
      background: #fff;
    }
    .site-notes label {
      font-weight: bold;
      display: block;
      margin-top: 5px;
    }
    .site-notes div[contenteditable] {
      border: 1px solid #ccc;
      padding: 6px;
      border-radius: 4px;
      background: #fff;
      min-height: 40px;
    }
    .holiday-sick-box {
      min-height: 60px;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .employee {
      padding: 8px;
      background: #e0e0e0;
      margin: 3px 0;
      border-radius: 4px;
      cursor: grab;
    }
    .drag-over {
      background-color: #d9f2ff;
      border-color: #4dabf7;
    }
  </style>
</head>
<body>
  <div class="logo">
    <img src="CS_logo_long.jpg" alt="Cornfield Scaffolding Logo">
  </div>
  <div class="main-columns" id="scheduler">
    <!-- Scheduler content will be inserted here -->
  </div>
  <div style="text-align:center; margin-top: 40px;">
    <button onclick="downloadScreenshot()" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">Download Schedule Screenshot</button>
  </div>

  <script>
    const initialEmployees = [
      "Matty O'donoughhoe", "Ashley Coleman", "Shane Clarke", "Luke Watts", "Tyler Didwell", "Robert Bone",
      "Tyler Pluck", "Tom Piper", "Luke Hughes", "Benny Ainge", "Reece Hendry", "Daniel Fisher",
      "Elliot Auld", "Ashley Dunthorne", "Louis Maynard", "Bradley Whymark", "Liam Bolt", "Ridley Bolt",
      "Steve White", "Spencer Lane", "John Goosetree", "Ashton Mason"
    ];

    const areas = [
      { type: 'unassigned', title: 'Employees' },
      { type: 'site', title: 'Work Sites', names: ['Elmswell (Orbit)', 'Dovecote (Orbit)', 'Ketts Meadow (Persimmon)', 'Cantley Sugar Factory'] },
      { type: 'truck', title: 'Trucks', names: ['PK61 SYC', 'DA11 FYS', 'HN09 HKA', 'SN65 EPF'] },
      { type: 'holiday', title: 'Holiday / Sick', names: ['Holiday', 'Sick'] }
    ];

    let dragged = null;

    function createLayout() {
      const container = document.getElementById('scheduler');
      areas.forEach(area => {
        const col = document.createElement('div');
        col.className = 'column';
        col.innerHTML = `<h2>${area.title}</h2>`;

        if (area.type === 'unassigned') {
          const box = document.createElement('div');
          box.className = 'unassigned';
          box.dataset.type = 'unassigned';
          initialEmployees.forEach(name => {
            const emp = document.createElement('div');
            emp.className = 'employee';
            emp.textContent = name;
            emp.setAttribute('draggable', true);
            box.appendChild(emp);
          });
          col.appendChild(box);
        } else {
          (area.names || []).forEach(name => {
            const box = document.createElement('div');
            box.className = 'site-box';
            box.innerHTML = `<h3>${name}</h3><div class="site-employees column" data-type="${area.type}" data-name="${name}"></div><div class="site-notes"><label>Notes:</label><div contenteditable="true"></div></div>`;
            col.appendChild(box);
          });
        }

        container.appendChild(col);
      });
    }

    function enableDragAndDrop() {
      document.addEventListener('dragstart', e => {
        if (e.target.classList.contains('employee')) {
          dragged = e.target;
          e.dataTransfer.effectAllowed = 'move';
        }
      });

      document.addEventListener('dragover', e => {
        const col = e.target.closest('.column');
        if (col) {
          e.preventDefault();
          col.classList.add('drag-over');
        }
      });

      document.addEventListener('dragleave', e => {
        const col = e.target.closest('.column');
        if (col) col.classList.remove('drag-over');
      });

      document.addEventListener('drop', e => {
        const validDrop = e.target.closest('.site-employees, .unassigned, .holiday-sick-box');
        if (validDrop && dragged) {
          validDrop.appendChild(dragged);
          validDrop.classList.remove('drag-over');
          dragged = null;
          saveState();
        }
      });

      document.querySelectorAll('.employee').forEach(el => {
        el.addEventListener('touchstart', () => { dragged = el; });
      });

      document.addEventListener('touchend', (e) => {
        if (!dragged) return;
        const touch = e.changedTouches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        const dropZone = target?.closest('.site-employees, .unassigned, .holiday-sick-box');
        if (dropZone) {
          dropZone.appendChild(dragged);
          saveState();
        }
        dragged = null;
      });
    }

    function saveState() {
      const state = {};
      document.querySelectorAll('.employee').forEach(emp => {
        const parent = emp.closest('[data-type]');
        const type = parent?.dataset.type;
        const name = parent?.dataset.name || type;
        if (!state[name]) state[name] = [];
        state[name].push(emp.textContent);
      });
      localStorage.setItem('jobState', JSON.stringify(state));
    }

    function loadState() {
      const stateStr = localStorage.getItem('jobState');
      if (!stateStr) return;
      try {
        const state = JSON.parse(stateStr);
        document.querySelectorAll('.employee').forEach(emp => emp.remove());
        for (let loc in state) {
          const box = [...document.querySelectorAll('[data-type], [data-name]')].find(d => d.dataset.name === loc || d.dataset.type === loc);
          if (!box) continue;
          state[loc].forEach(name => {
            const emp = document.createElement('div');
            emp.className = 'employee';
            emp.textContent = name;
            emp.setAttribute('draggable', true);
            box.appendChild(emp);
          });
        }
      } catch (e) { console.error('Failed to load state:', e); }
    }

    function downloadScreenshot() {
      html2canvas(document.getElementById('scheduler')).then(canvas => {
        const link = document.createElement('a');
        link.download = `schedule-${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    createLayout();
    enableDragAndDrop();
    window.onload = loadState;
  </script>
</body>
</html>
